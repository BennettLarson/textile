#!/bin/sh
# this file requires sh over bash:
set -e
user=textile
repo="$TEXTILE_REPO"

if [ $(id -u) -eq 0 ]; then
	echo "Changing user to $user"
	# ensure folder is writable
	su-exec "$user" test -w "$repo" || chown -R -- "$user" "$repo"
	# restart script with new privileges
	exec su-exec "$user" "$0" "$@"
fi

# ensure that threads service boots
sleep 2

# https://docs.docker.com/network/network-tutorial-standalone/
# clearest way i could find to programatically set the IP address of the service
if [[ -z "${DOCKER_COMPOSE}" ]]; then
	exec /usr/local/bin/textiled "$@"
else
	IP=$(ping -c 2 textile_threads | head -1 | awk -F "(" '{print $2}' | awk -F ")" '{print $1}')
	echo "Threads service found: $IP"
	exec /usr/local/bin/textiled --addrThreadsHostProxy=/ip4/$IP/tcp/4006 --addrThreadsHostProxy=/ip4/$IP/tcp/5050 --addrThreadsApi=/ip4/$IP/tcp/9090 --addrThreadsApiProxy=/ip4/$IP/tcp/9091
fi


